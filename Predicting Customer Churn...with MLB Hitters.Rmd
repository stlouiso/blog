---
title: "Predicting Customer Churn...with MLB Hitters"
description: |
  How will long will a customer stay with our business or, in this case, how long will a MLB hitter stay in the MLB? 
author:
  - name: Louis Oberdiear
    url: thelob.blog/louisoberdiear
date: 06-24-2021
output:
  distill::distill_article:
    self_contained: false
categories:
  - customer churn
  - data science
  - rstats
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r load-packages, message=FALSE}
library(tidyverse)
library(tidylog)
library(broom)
library(DataExplorer)
library(tidymodels)
```

Get the data

```{r}
library(Lahman)
data(People)
head(People) 
```

```{r}
data(Batting)
head(Batting) %>%
  arrange(playerID, yearID)
```

```{r}
pitchers <- Lahman::Pitching %>%
  select(playerID) %>%
  distinct()

old_players <- People %>%
  filter(ymd(debut) < '1950-01-01')

people_churn <- People %>%
  select(playerID, nameFirst, nameLast, birthDate, debut, finalGame) %>%
  filter(!is.na(finalGame)) %>%
  filter(ymd(finalGame) < '2018-01-01') %>%
  anti_join(old_players) %>%
  inner_join(Batting) %>%
  group_by(playerID, yearID) %>%
  summarise(nameFirst = first(nameFirst),
            nameLast = first(nameLast),
            birthDate = first(birthDate),
            debut = first(debut),
            finalGame = first(finalGame),
            stint = first(stint),
            teamID = first(teamID),
            lgID = first(lgID),
            G = sum(G),
            AB = sum(AB),
            R = sum(R),
            H = sum(H),
            X2B = sum(X2B),
            X3B = sum(X3B),
            HR = sum(HR),
            RBI = sum(RBI),
            SB = sum(SB),
            CS = sum(CS),
            BB = sum(BB),
            SO = sum(SO),
            IBB = sum(IBB),
            HBP = sum(HBP),
            SH = sum(SH),
            SF = sum(SF),
            GIDP = sum(GIDP),
            .groups = "drop") %>%
  anti_join(pitchers) %>%
  filter(lgID %in% c('NL', 'AL')) %>%
  Lahman::battingStats(data = .) %>%
  group_by(playerID, stint) %>%
  mutate(year_num = row_number()) %>%
  ungroup() %>%
  group_by(playerID) %>%
  mutate(tenure = n()) %>%
  ungroup() %>%
  mutate(age = as.double((ymd(paste0(yearID, '-01-01')) - ymd(birthDate))/365)) %>%
  drop_na()
```

```{r}
DataExplorer::plot_histogram(people_churn, nrow = 2, ncol = 2)
```



```{r}
lm1 <- lm(formula = tenure ~ age + year_num + AB + OPS, data = people_churn)

people_churn_preds <- people_churn %>%
  mutate(tenure_pred = lm1$fitted.values,
         resids = lm1$residuals)

tidy(lm1)

yardstick::metrics(data = people_churn_preds, truth = tenure, estimate = tenure_pred)
```

```{r}
data.frame(age = c(33),
           year_num = c(1),
           AB = c(600),
           OPS = c(1)) %>%
  predict(lm1, newdata = .)
```


```{r}
people_churn_preds <- people_churn %>%
  mutate(tenure_pred = lm1$fitted.values,
         resids = lm1$residuals)
```


```{r}
library(performance)
performance::check_model(lm1, panel = FALSE)
```

```{r}
performance::check_outliers(lm1)
```
```{r}
performance::performance_accuracy(lm1)
performance::model_performance(lm1)
```


```{r}
Lahman::Fielding %>% head()
Lahman::Salaries %>% head()
Lahman::Appearances %>% arrange(desc(yearID)) %>% head()
Lahman::AllstarFull %>% head()

```

```{r}

fielding <- Lahman::Fielding %>%
  group_by(playerID, yearID) %>%
  arrange(desc(G)) %>%
  mutate(pos_rank = row_number()) %>%
  ungroup() %>%
  filter(pos_rank == 1) %>%
  select(playerID, yearID, POS, G, GS, InnOuts, PO, A, E) %>%
  anti_join(old_players) %>%
  rename(G_pos = G)

people_churn <- people_churn %>%
  left_join(fielding, by = c("playerID", "yearID")) %>%
  replace_na(list(G_pos = 0, GS = 0, InnOuts = 0, PO = 0, A = 0, E = 0)) %>%
  mutate(fielding_pct = (PO + A) / (PO + A + E)) %>%
  group_by(POS) %>%
  mutate(field_pct_scaled = scale(fielding_pct)) %>%
  ungroup()

appearances <- Lahman::Appearances %>%
  group_by(playerID, yearID) %>%
  summarise(G_batting = sum(G_batting),
            G_defense = sum(G_defense),
            G_dh = sum(G_dh),
            G_ph = sum(G_ph))

people_churn <- people_churn %>%
  left_join(appearances, by = c("playerID", "yearID")) %>%
  
```


# To do

- analyse big residuals
- feature engineer to try and fix big residuals
- train using xgBoost

# General modeling outline

1. build simple baseline model
2. build simple blackbox model
3. analyze residuals from blackbox model
4. feature engineer to try and correct large residuals


A common list presented at Baseball-Reference described the eras as the Dead Ball Era (1901-1919), the Live Ball Era (1920-1941), the Integration Era (1942-1960), the Expansion Era (1961-1976), the Free Agency Era (1977-1993) and the Long Ball/Steroid Era (1994-2005) (17).


